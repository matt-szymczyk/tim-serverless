<!DOCTYPE html>
<html>
<head>
    <title>Image Upload</title>
    <script src="https://cdn.jsdelivr.net/npm/amazon-cognito-identity-js/dist/amazon-cognito-identity.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            border: 1px solid #ccc;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }
        button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        input {
            margin: 10px 0;
            padding: 5px;
        }
    </style>
</head>
<body>
    <div id="loginSection" class="container">
        <h2>Login</h2>
        <input type="text" id="username" placeholder="Username"><br>
        <input type="password" id="password" placeholder="Password"><br>
        <button onclick="login()">Login</button>
    </div>

    <div id="uploadSection" class="container" style="display: none;">
        <h2>Upload Image</h2>
        <input type="text" id="userId" placeholder="User ID"><br>
        <input type="file" id="imageFile" accept="image/*"><br>
        <button onclick="uploadImage()">Upload</button>
    </div>

    <script>
        // Configure your Cognito details here
        const poolData = {
            UserPoolId: 'eu-north-1_J7e4tl8B2', // Replace with your User Pool ID
            ClientId: '5o5kgscohrkogihj339mgj1ol8' // Replace with your App Client ID
        };

        const userPool = new AmazonCognitoIdentity.CognitoUserPool(poolData);
        let idToken = null;

        // async function login() {
        //     const username = document.getElementById('username').value;
        //     const password = document.getElementById('password').value;

        //     const authenticationData = {
        //         Username: username,
        //         Password: password,
        //     };

        //     const authenticationDetails = new AmazonCognitoIdentity.AuthenticationDetails(authenticationData);

        //     const userData = {
        //         Username: username,
        //         Pool: userPool
        //     };

        //     const cognitoUser = new AmazonCognitoIdentity.CognitoUser(userData);

        //     cognitoUser.authenticateUser(authenticationDetails, {
        //         onSuccess: function(result) {
        //             idToken = result.getIdToken().getJwtToken();
        //             document.getElementById('loginSection').style.display = 'none';
        //             document.getElementById('uploadSection').style.display = 'block';
        //         },
        //         onFailure: function(err) {
        //             alert('Error: ' + err.message);
        //         }
        //     });
        // }
        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            const authenticationData = {
                Username: username,
                Password: password,
            };

            const authenticationDetails = new AmazonCognitoIdentity.AuthenticationDetails(authenticationData);

            const userData = {
                Username: username,
                Pool: userPool
            };

            const cognitoUser = new AmazonCognitoIdentity.CognitoUser(userData);

            cognitoUser.authenticateUser(authenticationDetails, {
                onSuccess: function(result) {
                    idToken = result.getIdToken().getJwtToken();
                    document.getElementById('loginSection').style.display = 'none';
                    document.getElementById('uploadSection').style.display = 'block';
                },
                onFailure: function(err) {
                    alert('Error: ' + err.message);
                },
                newPasswordRequired: function(userAttributes, requiredAttributes) {
                    // Handle new password required challenge
                    const newPassword = prompt("Please enter a new password:"); // You might want to use a proper form instead
                    if (newPassword) {
                        // Delete these attributes or else the call will fail
                        delete userAttributes.email_verified;
                        delete userAttributes.phone_number_verified;
                        
                        cognitoUser.completeNewPasswordChallenge(newPassword, userAttributes, {
                            onSuccess: function(result) {
                                idToken = result.getIdToken().getJwtToken();
                                document.getElementById('loginSection').style.display = 'none';
                                document.getElementById('uploadSection').style.display = 'block';
                            },
                            onFailure: function(err) {
                                alert('Error setting new password: ' + err.message);
                            }
                        });
                    }
                }
            });
        }


        async function uploadImage() {
            const fileInput = document.getElementById('imageFile');
            const userId = document.getElementById('userId').value;
            
            if (!fileInput.files[0]) {
                alert('Please select a file');
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = async function(e) {
                const base64Image = e.target.result.split(',')[1];

                const data = {
                    userid: userId,
                    photo: base64Image
                };

                try {
                    const response = await fetch('https://6rf5igjsbe.execute-api.eu-north-1.amazonaws.com/DEV/form', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': idToken
                        },
                        body: JSON.stringify(data)
                    });

                    if (response.ok) {
                        alert('Upload successful!');
                    } else {
                        alert('Upload failed: ' + await response.text());
                    }
                } catch (error) {
                    alert('Error: ' + error.message);
                }
            };

            reader.readAsDataURL(file);
        }
    </script>
</body>
</html>
